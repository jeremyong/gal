



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="GAL - A fast C++17 geometric algebra library">
      
      
        <link rel="canonical" href="https://jeremyong.com/gal/optimizations/">
      
      
        <meta name="author" content="Jeremy Ong">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../images/blur_on.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>Optimizations - GAL</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#7e57c2">
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../css/main.css">
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-10576233-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="deep-purple" data-md-color-accent="deep-purple">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#optimizations" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://jeremyong.com/gal" title="GAL" class="md-header-nav__button md-logo">
          
            <i class="md-icon">blur_on</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              GAL
            </span>
            <span class="md-header-nav__topic">
              
                Optimizations
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/jeremyong/gal/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    jeremyong/gal
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://jeremyong.com/gal" title="GAL" class="md-nav__button md-logo">
      
        <i class="md-icon">blur_on</i>
      
    </a>
    GAL
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/jeremyong/gal/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    jeremyong/gal
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../quick-start/" title="Quick Start" class="md-nav__link">
      Quick Start
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Optimizations
      </label>
    
    <a href="./" title="Optimizations" class="md-nav__link md-nav__link--active">
      Optimizations
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#compilation-time" class="md-nav__link">
    Compilation time
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#runtime" class="md-nav__link">
    Runtime
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommended-compiler-flags" class="md-nav__link">
    Recommended compiler flags
  </a>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../benchmarks/" title="Benchmarks" class="md-nav__link">
      Benchmarks
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../coding-conventions/" title="Coding Conventions" class="md-nav__link">
      Coding Conventions
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../about/" title="About" class="md-nav__link">
      About
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#compilation-time" class="md-nav__link">
    Compilation time
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#runtime" class="md-nav__link">
    Runtime
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommended-compiler-flags" class="md-nav__link">
    Recommended compiler flags
  </a>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/jeremyong/gal/edit/master/docs/optimizations.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="optimizations">Optimizations</h1>
<p>This is a non-exhaustive set of notes to document the various optimizations that are incorporated in GAL.</p>
<h2 id="compilation-time">Compilation time</h2>
<ul>
<li>Multivector compile-time representations are templated based on the algebra they reside in (metric + basis) and the size of its constituent compile-time expressions. Representing multivectors as typechains (the traditional approach) is completely untenable for non-trivial work (your compiler will quickly run out of both time and memory).</li>
<li>Internally, multivectors contain three flat (compile-time constant expression) arrays refering to indeterminates, monomials, and polynomials. Monomials have a count and offset into the indeterminates array, and polynomials (multivector terms) have a count and offset into the monomials array. All arrays are sorted according to well-ordering defined on each (indterminates, monomials, and terms) so that operations like summation, multiplication, etc occur with minimal algorithmic complexity.</li>
<li>Function template instantiation is kept to a minimum, and use of <abbr title="Substitution Failure is Not an Error">SFINAE</abbr>, no matter how convenient, is forbidden.</li>
<li>The final reification does NOT rely on <code>constexpr</code> expansion because this would introduce a function call that the compiler cannot reasonably inline (affects final performance by 10x!). This is done in a type expansion instead at the cost of some compile-time performance.</li>
<li>Compile-time rational addition and multiplication is guarded against overflows carefully and if an overflow is about to occur, mediant approximation is used.</li>
<li>Exponentiation is unrolled out compile time using binary right-to-left expansion since the exponent itself is known at compile time. When fractional exponents are present, a single call to <code>std::pow</code> is used instead.</li>
<li>GAL is extremely careful about how its headers are organized so that the parser has minimal work to do. In particular, GAL does whatever it can to avoid the inclusion of system headers unless absolutely necessary. The substitutions made for leaner classes do <em>not</em> show up in the final build (they are only used for intermediate computation) and are measurably quicker to compile.</li>
</ul>
<h2 id="runtime">Runtime</h2>
<ul>
<li>Because expressions are reduced first over the field of rational coefficients in the polynomial ring of finitely generated indeterminates (the expression inputs), term cancellation occurs exactly.</li>
<li>When terms would not appear in the final computed result, no instructions are generated.</li>
<li>If terms drop out in the final result, the type the computation is reified to does not include that term (reflected in <code>sizeof(result)</code>).</li>
<li>When converting an entity result into a concrete entity that has a greater size, a zero is written to the unoccupied terms as cheaply as possible (this is just zero-initialization).</li>
<li>All expression computation is zero-copy, meaning it is up to the compiler if it wishes to rearrange the data (e.g. in <abbr title="Single Instruction Multiple Data">SIMD</abbr> registers).</li>
<li>While needless sprinkling of <code>inline</code> and inline-forcing attributes is generally ill-advised, it's absolutely critical in GAL. GCC in particular has trouble inlining certain code that is actually completely elidable at compile time due to the expression complexity. As a result, using the force-inline attribute guarantees inlines in places where it was deemed important (and guaranteed not to introduce unnecessary code bloat). In places in GAL where <code>GAL_FORCE_INLINE</code> is used, the code will actually both shrink in size <em>and</em> accelerate in speed.</li>
</ul>
<h2 id="recommended-compiler-flags">Recommended compiler flags</h2>
<p>The philosophy adopted by the author of GAL is that algorithms should be numerically robust such that floating point math can be regarded as associative. While this is sometimes more difficult to achieve, the gains are often well worth it as associativity enables the compiler to more easily vectorize and fuse operations. GA affords a good degree of numerical stability already. For example, a rigid body motion or rotation in GA is minimally parameterized. In contrast, the multiplication of several rotation matrices can quickly get out of hand, as the correlated off-diagonal elements drift breaking normalization. As such, users of GAL are recommended to consider the following compiler flags, at the very least, on a translation unit by translation unit basis.</p>
<div class="admonition info">
<p class="admonition-title">MSVC Usage</p>
<p>Unlike GCC and Clang, MSVC provides a single control flag to modify the floating point environment. For MSVC, <code>/fp:fast</code> is recommended which enables all recommendations described in more detail below.</p>
</div>
<p>The flags mentioned below apply to both GCC and Clang:</p>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Purpose</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-fno-signed-zeros</code></td>
<td>Disables the signed representation of zeros.</td>
<td>Signed zeros are traditionally used to ensure that a divide by zero will create the correct infinity (there is a big difference between <script type="math/tex">+\infty</script> and <script type="math/tex">-\infty</script>). Under projectivization, many operations that would have historically produced an infinity map instead to an ideal. The other case where division by zero may arise is during normalization, but in such a case, the result will be incorrect regardless of the sign of the infinity produced.</td>
</tr>
<tr>
<td><code>-ffinite-math-only</code></td>
<td>The compiler will no longer honor infinities.</td>
<td>As mentioned, infinities under projectivization map to a finite quantity in all cases, and honoring infinities is wasteful.</td>
</tr>
<tr>
<td><code>-funsafe-math-optimizations</code></td>
<td>Permit associative operation reordering.</td>
<td>Floating point expressions like <script type="math/tex">(x + y) + z</script> and <script type="math/tex">x + (y + z)</script> are not equivalent in general due to rounding errors. It is the opinion of the author that computation should generally be done in ideal precision ranges where possible. GA naturally avoids a number of pathological cases such as adding/multiplying a large number followed by subtracting/dividing by a large number.</td>
</tr>
<tr>
<td><code>-fno-trapping-math</code></td>
<td>Disables trapping floating point exceptions such as divide by zero and overflow.</td>
<td>Normalizing entities such as motors, points, etc. are the only instance where a divide by zero can occur and overflow is conditioned on a reasable coordinate system (object space vs world space, etc). It is preferable to just check for what would have been a possible exception in the isolated cases where it is needed than to enable exception trapping everywhere.</td>
</tr>
</tbody>
</table>
<p>For convenience, the flag <code>-ffast-math</code> enables all the flags above and should be usable with GAL.</p>
<p>Additionally, the hardware-dependent flags below are recommended if permitted by your deployment requirements:</p>
<table>
<thead>
<tr>
<th>GCC/Clang Flag</th>
<th>MSVC Flag</th>
<th>AMD Support</th>
<th>Intel Support</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-mfma</code></td>
<td><code>/arch:AVX2</code> and <code>/fp:fast</code></td>
<td>Piledriver and later (2013)</td>
<td>Haswell and later (2014)</td>
<td>Compilers have gotten exceptionally good at identifying patterns and expressions that benefit from the fused-multiply-add instruction. This instruction not only increases speed but it also increases precision because the entire compound operation is completed at full precision before rounding. These flags correspond to <code>FMA3</code><sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup></td>
</tr>
<tr>
<td><code>-march=native</code></td>
<td></td>
<td>Any</td>
<td>Any</td>
<td>If you control the final target, using <code>-march=native</code> will provide the most aggressive optimizations possible for the target hardware being compiled on.</td>
</tr>
</tbody>
</table>
<p>It goes without saying that all other standard practices apply (prefer 64-bit due to the additional register count, etc).</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>The <code>FMA4</code> set of instructions can help in some circumstances, but personally, I haven't found them to be worth the loss in compatibility afforded by using the slightly older (but very good) <code>FMA3</code> instructions.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
                
                  
                
              
              
                


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "https://jeremyong.com/gal/optimizations/";
      this.page.identifier =
        "/optimizations/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//jeremyong.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../quick-start/" title="Quick Start" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Quick Start
              </span>
            </div>
          </a>
        
        
          <a href="../benchmarks/" title="Benchmarks" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Benchmarks
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2019 Jeremy Ong
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/jeremyong" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/m_ninepoints" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/in/jeremycong" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>