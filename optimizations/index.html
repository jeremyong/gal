<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="GAL - A fast C++17 geometric algebra library">
    <meta name="author" content="Jeremy Ong">
    <link rel="canonical" href="https://jeremyong.com/gal/optimizations/">
    <link rel="../img/favicon.ico">

    
    <title>Optimizations - GAL</title>
    

    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../css/base.min.css" rel="stylesheet">
    <link href="../css/cinder.min.css" rel="stylesheet">
    <link href="../css/highlight.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    <script src="//ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    
    <script>
    (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-10576233-1', 'jeremyong.com');
    ga('send', 'pageview');
    </script>
    

     
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            <a class="navbar-brand" href="..">GAL</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="..">Quick Start</a>
                    </li>
                
                
                
                    <li class="active">
                        <a href="./">Optimizations</a>
                    </li>
                
                
                
                    <li >
                        <a href="../coding-conventions/">Coding Conventions</a>
                    </li>
                
                
                
                    <li >
                        <a href="../about/">About</a>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
                    <li >
                        <a rel="prev" href="..">
                            <i class="fas fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="next" href="../coding-conventions/">
                            Next <i class="fas fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/jeremyong/gal/edit/master/docs/optimizations.md"><i class="fab fa-github"></i> Edit on GitHub</a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#optimizations">Optimizations</a></li>
            <li class="second-level"><a href="#compilation-time">Compilation time</a></li>
                
            <li class="second-level"><a href="#runtime">Runtime</a></li>
                
            <li class="second-level"><a href="#recommended-compiler-flags">Recommended compiler flags</a></li>
                
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="optimizations">Optimizations</h1>
<p>This is a non-exhaustive set of notes to document the various optimizations that are incorporated in GAL.</p>
<h2 id="compilation-time">Compilation time</h2>
<ul>
<li>Multivector compile-time representations are templated based on the algebra they reside in (metric + basis) and the size of its constituent compile-time expressions. Representing multivectors as typechains (the traditional approach) is completely untenable for non-trivial work (your compiler will quickly run out of both time and memory).</li>
<li>Internally, multivectors contain 3 flat (compile-time constant expression) arrays refering to indeterminates, monomials, and polynomials. Monomials have a count and offset into the indeterminates array, and polynomials (multivector terms) have a count and offset into the monomials array. All arrays are sorted according to well-ordering defined on each (indterminates, monomials, and terms) so that operations like summation, multiplication, etc occur with minimal algorithmic complexity.</li>
<li>Function template instantiation is kept to a minimum, and use of SFINAE, no matter how convenient, is forbidden.</li>
<li>The final reification does NOT rely on <code>constexpr</code> expansion because this would introduce a function call that the compiler cannot reasonably inline (affects final performance by 10x!). This is done in a type expansion instead at the cost of some compile-time performance.</li>
<li>Compile-time rational addition and multiplication is guarded against overflows carefully and if an overflow is about to occur, mediant approximation is used.</li>
<li>Exponentiation is unrolled out compile time using binary right-to-left expansion since the exponent itself is known at compile time. When fractional exponents are present, a single call to <code>std::pow</code> is used instead.</li>
</ul>
<h2 id="runtime">Runtime</h2>
<ul>
<li>Because expressions are reduced first over the field of rational coefficients in the polynomial ring of finitely generated indeterminates (the expression inputs), term cancellation occurs exactly.</li>
<li>When terms would not appear in the final computed result, no instructions are generated.</li>
<li>If terms drop out in the final result, the type the computation is reified to does not include that term (reflected in <code>sizeof(result)</code>).</li>
<li>When converting an entity result into a concrete entity that has a greater size, a zero is written to the unoccupied terms as cheaply as possible (this is just zero-initialization).</li>
<li>All expression computation is zero-copy, meaning it is up to the compiler if it wishes to rearrange the data (e.g. in SIMD registers).</li>
</ul>
<p>Here are some preliminary results for the <code>GABenchmark_AlgorithmInverseKinematics_ConformalModel_D3</code> benchmark provided by <a href="https://github.com/ga-developers/ga-benchmark">gabenchmark</a> (all benchmarks compiled with <code>-O2 -mfma</code> using GCC 10). Prior to each benchmark, CPU scaling was turned off for consistent results.</p>
<table>
<thead>
<tr>
<th>Library</th>
<th>Time</th>
<th>Iterations</th>
<th>Iterations/ns</th>
<th>Speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/wolftype/versor">Versor</a></td>
<td>1138 ns</td>
<td>608337</td>
<td>535/ns</td>
<td>1x</td>
</tr>
<tr>
<td><a href="https://github.com/laffernandes/gatl">GATL</a></td>
<td>469 ns</td>
<td>1505207</td>
<td>3209/ns</td>
<td>5.998x</td>
</tr>
<tr>
<td><a href="https://github.com/jeremyong/gal">GAL</a></td>
<td>376 ns</td>
<td>1873236</td>
<td>4982/ns</td>
<td>9.312x</td>
</tr>
</tbody>
</table>
<p>This was tested on an Intel i9-9900K.</p>
<h2 id="recommended-compiler-flags">Recommended compiler flags</h2>
<p>The philosophy adopted by the author of GAL is that algorithms should be numerically robust such that floating point math can be regarded as associative. While this is sometimes more difficult to achieve, the gains are often well worth it as associativity enables the compiler to more easily vectorize and fuse operations. GA affords a good degree of numerical stability already. For example, a rigid body motion or rotation in GA is minimally parameterized. In contrast, the multiplication of several rotation matrices can quickly get out of hand, as the correlated off-diagonal elements drift breaking normalization. As such, users of GAL are recommended to consider the following compiler flags, at the very least, on a translation unit by translation unit basis.</p>
<blockquote>
<p>Note for MSVC users: Unlike GCC and Clang, MSVC provides a single control flag to modify the floating point environment. For MSVC, <code>/fp:fast</code> is recommended which enables all recommendations described in more detail below.</p>
</blockquote>
<p>The flags mentioned below apply to both GCC and Clang:</p>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Purpose</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-fno-signed-zeros</code></td>
<td>Disables the signed representation of zeros.</td>
<td>Signed zeros are traditionally used to ensure that a divide by zero will create the correct infinity (there is a big difference between <script type="math/tex">+\infty</script> and <script type="math/tex">-\infty</script>). Under projectivization, many operations that would have historically produced an infinity map instead to an ideal. The other case where division by zero may arise is during normalization, but in such a case, the result will be incorrect regardless of the sign of the infinity produced.</td>
</tr>
<tr>
<td><code>-ffinite-math-only</code></td>
<td>The compiler will no longer honor infinities.</td>
<td>As mentioned, infinities under projectivization map to a finite quantity in all cases, and honoring infinities is wasteful.</td>
</tr>
<tr>
<td><code>-funsafe-math-optimizations</code></td>
<td>Permit associative operation reordering.</td>
<td>Floating point expressions like <script type="math/tex">(x + y) + z</script> and <script type="math/tex">x + (y + z)</script> are not equivalent in general due to rounding errors. It is the opinion of the author that computation should generally be done in ideal precision ranges where possible. GA naturally avoids a number of pathological cases such as adding/multiplying a large number followed by subtracting/dividing by a large number.</td>
</tr>
<tr>
<td><code>-fno-trapping-math</code></td>
<td>Disables trapping floating point exceptions such as divide by zero and overflow.</td>
<td>Normalizing entities such as motors, points, etc. are the only instance where a divide by zero can occur and overflow is conditioned on a reasable coordinate system (object space vs world space, etc). It is preferable to just check for what would have been a possible exception in the isolated cases where it is needed than to enable exception trapping everywhere.</td>
</tr>
</tbody>
</table>
<p>For convenience, the flag <code>-ffast-math</code> enables all the flags above and should be usable with GAL.</p>
<p>Additionally, the hardware-dependent flags below are recommended if permitted by your deployment requirements:</p>
<table>
<thead>
<tr>
<th>GCC/Clang Flag</th>
<th>MSVC Flag</th>
<th>AMD Support</th>
<th>Intel Support</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-mfma</code></td>
<td><code>/arch:AVX2</code> and <code>/fp:fast</code></td>
<td>Piledriver and later (2013)</td>
<td>Haswell and later (2014)</td>
<td>Compilers have gotten exceptionally good at identifying patterns and expressions that benefit from the fused-multiply-add instruction. This instruction not only increases speed but it also increases precision because the entire compound operation is completed at full precision before rounding.</td>
</tr>
<tr>
<td><code>-march=native</code></td>
<td></td>
<td>Any</td>
<td>If you control the final target, using <code>-march=native</code> will provide the most aggressive optimizations possible for the target hardware being compiled on.</td>
<td></td>
</tr>
</tbody>
</table>
<p>It goes without saying that all other standard practices apply (prefer 64-bit due to the additional register count, etc).</p></div>
        
        
    </div>

    <footer class="col-md-12 text-center">
        
        <hr>
        <p>
        <small>Jeremy Ong 2019<br></small>
        
        <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p></small>

        
        
    </footer>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../js/bootstrap-3.0.3.min.js"></script>
    <script src="../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>var base_url = ".."</script>
    
    <script src="../js/base.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    </body>

</html>
